<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Imageable: app/processing.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="imageable.ico"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Imageable
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">Gestão e recuperação de fotografias digitais</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('processing_8py_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">processing.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="processing_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="namespaceprocessing.html">    1</a></span>&#160; </div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">import</span> json</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">import</span> string</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">import</span> reverse_geocoder <span class="keyword">as</span> rg</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">import</span> threading</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">from</span> app.face_recognition <span class="keyword">import</span> FaceRecognition</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">from</span> app.breed_classifier <span class="keyword">import</span> BreedClassifier</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">from</span> urllib.parse <span class="keyword">import</span> unquote</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">import</span> random</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">from</span> neomodel <span class="keyword">import</span> db</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">from</span> numpyencoder <span class="keyword">import</span> NumpyEncoder</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keyword">from</span> app.fileSystemManager <span class="keyword">import</span> SimpleFileSystemManager</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keyword">from</span> app.models <span class="keyword">import</span> ImageNeo, Person, Tag, Location, Country, City, Folder, ImageES, Region</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keyword">from</span> app.object_extraction <span class="keyword">import</span> ObjectExtract</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="keyword">from</span> app.utils <span class="keyword">import</span> ImageFeature, get_images_per_uri, ImageFeaturesManager, ocrLock, processingLock, resultsLock, uploadLock, objectLock, breedLock,locationLock,faceRecLock,placesLock, lock</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keyword">import</span> torch</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable <span class="keyword">as</span> V</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keyword">import</span> torchvision.models <span class="keyword">as</span> models</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms <span class="keyword">as</span> trn</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keyword">import</span> os</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">from</span> imutils.object_detection <span class="keyword">import</span> non_max_suppression</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">import</span> cv2</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">import</span> pytesseract</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">import</span> re</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">from</span> nltk.corpus <span class="keyword">import</span> stopwords, words</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">from</span> nltk.tokenize <span class="keyword">import</span> word_tokenize</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">from</span> exif <span class="keyword">import</span> Image <span class="keyword">as</span> ImgX</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">from</span> app.VGG_ <span class="keyword">import</span> VGGNet</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">from</span> scripts.esScript <span class="keyword">import</span> es</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">import</span> app.utils</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">from</span> scripts.pathsPC <span class="keyword">import</span> do,numThreads</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">import</span> logging</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160; </div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="keyword">import</span> psutil, time</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">from</span> scripts.pcVariables <span class="keyword">import</span> ocrPath</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a520150ad453e3e1794a12883b0c331ae">   44</a></span>&#160;logging.basicConfig(level=logging.INFO)</div>
<div class="line"><a name="l00045"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#aa00adb123e43d4a4303930b0a6438df4">   45</a></span>&#160;cpuPerThread = 1</div>
<div class="line"><a name="l00046"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a06aceeb3d77f3294aeb6ff1a255cbdec">   46</a></span>&#160;ramPerThread = 1</div>
<div class="line"><a name="l00047"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ade153a3ae7a3478aa14110e039d9cfda">   47</a></span>&#160;threadTasks = {}</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160; </div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160; </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160; </div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160; </div>
<div class="line"><a name="l00054"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a059ae8f8c3d854183ac4da8ae162027b">   54</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a059ae8f8c3d854183ac4da8ae162027b">testing_thread_capacity</a>():</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="keyword">global</span> cpuPerThread</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="keyword">global</span> ramPerThread</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160; </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    dir_path = os.path.dirname(os.path.realpath(__file__))</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    dir_path = os.path.join(dir_path,<span class="stringliteral">&quot;static/tests&quot;</span>)</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    threadTasks[dir_path] = 0</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    wait = <a class="code" href="namespacepaths_p_c.html#a185f7998cf8604f1faea677e99324224">do</a>(processing, {dir_path: [<span class="stringliteral">&quot;face.jpg&quot;</span>]})</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    cpu_normal = psutil.cpu_percent()</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    ram_normal = psutil.virtual_memory().percent</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160; </div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    cpu_sum = 0</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    ram_sum = 0</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    iterating = 0</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordflow">while</span> <span class="keywordflow">not</span> wait.done():</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        time.sleep(0.1)</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        cpu_sum += psutil.cpu_percent()</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        ram_sum += psutil.virtual_memory().percent</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        iterating += 1</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160; </div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    cpu_med = (cpu_sum / iterating)</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    ram_med = (ram_sum / iterating)</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <a class="code" href="namespaceprocessing.html#afd4f5f8a5b495c94ebee7f5bfbedddae">delete_folder</a>(dir_path, frr)</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    cpuPerThread = cpu_med - cpu_normal</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    cpuPerThread /= 2</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160; </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    if(cpuPerThread &lt;= 0):</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        cpuPerThread = (cpuPerThread * -1) + 1</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160; </div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    ramPerThread = ram_med - ram_normal</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    ramPerThread /= 2</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160; </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    if(ramPerThread &lt;= 0):</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        ramPerThread = (ramPerThread * -1) + 1</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        </div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;logging.info(<span class="stringliteral">&quot;[Loading]: [INFO] Loading Object Extraction&quot;</span>)</div>
<div class="line"><a name="l00091"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a443f9261615aa534aa6744355919753d">   91</a></span>&#160;obj_extr = <a class="code" href="namespacepaths_p_c.html#a185f7998cf8604f1faea677e99324224">do</a>(ObjectExtract)</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160; </div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;logging.info(<span class="stringliteral">&quot;[Loading]: [INFO] Loading face recognition&quot;</span>)</div>
<div class="line"><a name="l00094"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a359af1def97ddf572573643aceeb6820">   94</a></span>&#160;frr = <a class="code" href="namespacepaths_p_c.html#a185f7998cf8604f1faea677e99324224">do</a>(FaceRecognition)</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160; </div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;logging.info(<span class="stringliteral">&quot;[Loading]: [INFO] Loading breed classifier&quot;</span>)</div>
<div class="line"><a name="l00097"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a08f208ffe6bcdf72e8c331d1c753e2e3">   97</a></span>&#160;bc = <a class="code" href="namespacepaths_p_c.html#a185f7998cf8604f1faea677e99324224">do</a>(BreedClassifier)</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160; </div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="keywordflow">while</span> <span class="keywordflow">not</span> obj_extr.done():</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    time.sleep(0.1)</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160; </div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;obj_extr = obj_extr.result()</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;logging.info(<span class="stringliteral">&quot;[Loading]: [INFO] Finished loading Object Extraction&quot;</span>)</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="keywordflow">while</span> <span class="keywordflow">not</span> frr.done():</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    time.sleep(0.1)</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;frr = frr.result()</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;logging.info(<span class="stringliteral">&quot;[Loading]: [INFO] Finished loading face recognition&quot;</span>)</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160; </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="keywordflow">while</span> <span class="keywordflow">not</span> bc.done():</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    time.sleep(0.1)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;bc = bc.result()</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;logging.info(<span class="stringliteral">&quot;[Loading]: [INFO] Finished loading breed classifier&quot;</span>)</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a3c58a6431740f38c32d6f389bed1e6e6">  115</a></span>&#160;ftManager = ImageFeaturesManager()</div>
<div class="line"><a name="l00116"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a3fb314d7310c3b315c40d660975f649c">  116</a></span>&#160;fs = SimpleFileSystemManager()</div>
<div class="line"><a name="l00117"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a97dd0d781148b6cf05574b719052d297">  117</a></span>&#160;model = VGGNet()</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160; </div>
<div class="line"><a name="l00119"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ae235cb393162ae69203f695e15c0a53d">  119</a></span>&#160;faceimageindex=0</div>
<div class="line"><a name="l00120"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ad659056bb39ad28cfa84ba9d7c968bcc">  120</a></span>&#160;THUMBNAIL_PIXELS=100</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160; </div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment"># used in getOCR</span></div>
<div class="line"><a name="l00123"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a9e9f5e74de6d45c219d0e3977b35b411">  123</a></span>&#160;east = <span class="stringliteral">&quot;frozen_east_text_detection.pb&quot;</span></div>
<div class="line"><a name="l00124"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ad3e0eff5c30b91593e592f52f8cdb8e3">  124</a></span>&#160;net = cv2.dnn.readNet(east)</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160; </div>
<div class="line"><a name="l00126"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a8a801542c44425d3fea56c42a905751e">  126</a></span>&#160;pytesseract.pytesseract.tesseract_cmd = ocrPath</div>
<div class="line"><a name="l00127"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#acd4574a34de9c8487fa9009bddca7ef1">  127</a></span>&#160;custom_config = <span class="stringliteral">r&#39;--oem 3 --psm 6&#39;</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160; </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment"># used in getPlaces</span></div>
<div class="line"><a name="l00130"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a52886d647dd3bc36948d822227e21b7e">  130</a></span>&#160;arch = <span class="stringliteral">&#39;resnet18&#39;</span>  <span class="comment"># th architecture to use</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment"># load the pre-trained weights</span></div>
<div class="line"><a name="l00132"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#af6ed920c38998b9d0e3044bae01c1f35">  132</a></span>&#160;model_file = <span class="stringliteral">&#39;%s_places365.pth.tar&#39;</span> % arch</div>
<div class="line"><a name="l00133"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a19953bae0e829c6dff043c86721bd1e2">  133</a></span>&#160;places_model = models.__dict__[arch](num_classes=365)</div>
<div class="line"><a name="l00134"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a4a03d43f8939d482e83a0e472a974da3">  134</a></span>&#160;checkpoint = torch.load(model_file, map_location=<span class="keyword">lambda</span> storage, loc: storage)</div>
<div class="line"><a name="l00135"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a9c0b8038e8b96f5f245975885ba02f89">  135</a></span>&#160;state_dict = {str.replace(k, <span class="stringliteral">&#39;module.&#39;</span>, <span class="stringliteral">&#39;&#39;</span>): v <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> checkpoint[<span class="stringliteral">&#39;state_dict&#39;</span>].items()}</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;places_model.load_state_dict(state_dict)</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;places_model.eval()</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160; </div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment"># load the image transformer</span></div>
<div class="line"><a name="l00140"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ad39cb15a9208e17a561a898f53d96640">  140</a></span>&#160;centre_crop = trn.Compose([</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    trn.Resize((256, 256)),</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    trn.CenterCrop(224),</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    trn.ToTensor(),</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    trn.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;])</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160; </div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160; </div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160; </div>
<div class="line"><a name="l00151"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#aa77cdec045c4ead9c001564b7c299c58">  151</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#aa77cdec045c4ead9c001564b7c299c58">filter_sentence</a>(sentence):</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    english_vocab = set(w.lower() <span class="keywordflow">for</span> w <span class="keywordflow">in</span> words.words())</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    stop_words = set(w.lower() <span class="keywordflow">for</span> w <span class="keywordflow">in</span> stopwords.words(<span class="stringliteral">&#39;english&#39;</span>))</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    word_tokens = word_tokenize(sentence)</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    filtered = [word.lower() <span class="keywordflow">for</span> word <span class="keywordflow">in</span> word_tokens <span class="keywordflow">if</span> word <span class="keywordflow">not</span> <span class="keywordflow">in</span> stop_words <span class="keywordflow">if</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                len(word) &gt;= 4 <span class="keywordflow">and</span> (len(word) &lt;= 8 <span class="keywordflow">or</span> word <span class="keywordflow">in</span> english_vocab)]</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keywordflow">return</span> filtered</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160; </div>
<div class="line"><a name="l00162"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a6883b4d7a4f9a026ab1bea1a737b7115">  162</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a6883b4d7a4f9a026ab1bea1a737b7115">upload_images</a>(uri):</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    logging.info(<span class="stringliteral">&quot;----------------------------------------------&quot;</span>)</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    logging.info(<span class="stringliteral">&quot;            feature extraction starts         &quot;</span>)</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    logging.info(<span class="stringliteral">&quot;----------------------------------------------&quot;</span>)</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160; </div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    dir_files = <a class="code" href="namespaceutils.html#a49f82a60715bd4d6d1fcf976ecf2319a">get_images_per_uri</a>(uri)</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    cpu_curr = psutil.cpu_percent()</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    ram_curr = psutil.virtual_memory().percent</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    free_cpu = (100 - cpu_curr) / 5</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    free_ram = (100 - ram_curr) / 5</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    threads = free_cpu / cpuPerThread</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    threads_ram = free_ram / ramPerThread</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160; </div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    if(threads_ram &lt; threads):</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        threads = threads_ram</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    threads = int(threads)</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    if(threads &gt; numThreads):</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        threads = numThreads</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160; </div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    if(threads &lt;= 0):</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        threads = 1</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    threads = int(threads)</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    logging.info(<span class="stringliteral">&quot;[Uploading]: Dividing&quot;</span>)</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    tasks = <a class="code" href="namespaceprocessing.html#a457624c262d19d657f133d859240bd73">divide_tasks_to_many</a>(dir_files, threads)</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    folders = []</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keywordflow">for</span> task <span class="keywordflow">in</span> tasks:</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        logging.info(<span class="stringliteral">&quot;[Processing]: [INFO] Task found: &quot;</span> + str(task))</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        folders += list(task.keys())</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    folders = list(set(folders))</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    logging.info(<span class="stringliteral">&quot;[Uploading]: Folders found &quot;</span> + str(folders))</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        uploadLock.acquire()</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keywordflow">for</span> dir_path <span class="keywordflow">in</span> folders:</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            <span class="keywordflow">if</span> dir_path <span class="keywordflow">in</span> threadTasks:</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                [task.pop(dir_path) <span class="keywordflow">for</span> task <span class="keywordflow">in</span> tasks <span class="keywordflow">if</span> dir_path <span class="keywordflow">in</span> task.keys()]</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;            <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                threadTasks[dir_path] = 0</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        uploadLock.release()</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160; </div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    i = 1</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordflow">for</span> task <span class="keywordflow">in</span> tasks:</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        logging.info(<span class="stringliteral">&quot;------------------task &quot;</span> + str(i) +<span class="stringliteral">&quot; ------------------&quot;</span>)</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keywordflow">if</span> task == {}:</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;            <span class="keywordflow">continue</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <a class="code" href="namespacepaths_p_c.html#a185f7998cf8604f1faea677e99324224">do</a>(processing, task)</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160; </div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        i += 1</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160; </div>
<div class="line"><a name="l00214"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a457624c262d19d657f133d859240bd73">  214</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a457624c262d19d657f133d859240bd73">divide_tasks_to_many</a>(dir_files, qty):</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    threading = 0</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    tasks = []</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160; </div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(1, qty + 1):</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        tasks.append({})</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160; </div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="comment"># dirFiles -&gt; {key: values}  key -&gt; C:users/user/databse, values-&gt; 1.jpg, 2.jpg</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordflow">for</span> path <span class="keywordflow">in</span> dir_files.keys():</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keywordflow">for</span> image <span class="keywordflow">in</span> dir_files[path]:</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            if(path <span class="keywordflow">not</span> <span class="keywordflow">in</span> tasks[threading].keys()):</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                tasks[threading][path] = [image]</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                tasks[threading][path] += [image]</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;            threading += 1</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            if(threading &gt;= len(tasks)):</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                threading = 0</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160; </div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordflow">return</span> tasks</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160; </div>
<div class="line"><a name="l00236"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#af9bda498b14617e7bc33bf221cb10d94">  236</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#af9bda498b14617e7bc33bf221cb10d94">face_rec_part</a>(read_image, img_path, tags, image):</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="comment"># image aberta -&gt; read_image</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    openimage, boxes = frr.get_face_boxes(open_img=read_image, image_path=img_path)</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160; </div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="keywordflow">for</span> b <span class="keywordflow">in</span> boxes:</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        name, enc, conf = frr.get_the_name_of(openimage, b)</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <span class="keywordflow">if</span> name <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            <span class="comment"># esta verificacao terá de ser alterada para algo mais preciso</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            <span class="comment"># por exemplo, definir um grau de certeza</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;            name = <span class="stringliteral">&#39;&#39;</span>.join(random.choice(string.ascii_letters) <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(10))</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        frr.save_face_identification(name=name, encoding = enc, conf=conf, imghash=image.hash)</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160; </div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        face_thumb_path = os.path.join(<span class="stringliteral">&#39;static&#39;</span>, <span class="stringliteral">&#39;face-thumbnails&#39;</span>, str(int(round(time.time() * 1000))) + <span class="stringliteral">&#39;.jpg&#39;</span>)</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        app.utils.get_face_thumbnail(openimage, b, save_in=os.path.join(<span class="stringliteral">&#39;app&#39;</span>, face_thumb_path))</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        p = Person.nodes.get_or_none(name=name)</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <span class="keywordflow">if</span> p <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            p = Person(name=name).save()</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160; </div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        tags.append(name)</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160; </div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="comment"># encodings falta</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        image.person.connect(p, {<span class="stringliteral">&#39;coordinates&#39;</span>: list(b), <span class="stringliteral">&#39;icon&#39;</span>: face_thumb_path, <span class="stringliteral">&#39;confiance&#39;</span>: conf, <span class="stringliteral">&#39;encodings&#39;</span>: enc, <span class="stringliteral">&#39;approved&#39;</span>: <span class="keyword">False</span>})</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        <span class="comment"># &quot;&quot;&quot;</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160; </div>
<div class="line"><a name="l00262"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a01037731001eee2546cce6a25c65a237">  262</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a01037731001eee2546cce6a25c65a237">classify_breed_part</a>(read_image, tags, image_db):</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    breed, breed_conf = bc.predict_image(read_image)</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">if</span> breed_conf &gt; app.utils.breedsThreshold:</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        tags.append(breed)</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160; </div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        tag = Tag.nodes.get_or_none(name=breed)</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="keywordflow">if</span> tag <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;            tag = Tag(name=breed).save()</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        image_db.tag.connect(tag, {<span class="stringliteral">&#39;originalTagName&#39;</span>:breed, <span class="stringliteral">&#39;originalTagSource&#39;</span>: <span class="stringliteral">&#39;breeds&#39;</span>, <span class="stringliteral">&#39;score&#39;</span>:breed_conf})</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160; </div>
<div class="line"><a name="l00274"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a86f5bb195977b996d1f35f93c860356f">  274</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a86f5bb195977b996d1f35f93c860356f">processing</a>(dir_files):</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    proc_string = <span class="stringliteral">&quot;[Processing]:&quot;</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160; </div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <a class="code" href="namespaceprocessing.html#ad699018dcd445ec6dc4f311845473892">add_thread_tasks</a>(dir_files)</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160; </div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordflow">for</span> dir <span class="keywordflow">in</span> dir_files.keys():</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        img_list = dir_files[dir]</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160; </div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        last_node = <a class="code" href="namespaceprocessing.html#a5170c685dfabb7aa5c9ce4b3d6f6eced">check_if_folder_exists_and_create_it</a>(dir)</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160; </div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        at_least_one = <span class="keyword">False</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        folder_neo_node = Folder.nodes.get(id_=last_node.id)</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        <span class="keywordflow">for</span> index, img_name <span class="keywordflow">in</span> enumerate(img_list):</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            skip, at_least_one = <a class="code" href="namespaceprocessing.html#a064a656947735445fff0ca50082629ac">extraction_process</a>(at_least_one, dir, folder_neo_node, img_list, img_name, index,</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                                              proc_string)</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            <span class="keywordflow">if</span> skip:</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                <span class="keywordflow">continue</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> at_least_one:</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                processingLock.acquire()</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                fs.delete_folder_from_fs(dir, frr)</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;            <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                processingLock.release()</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160; </div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <a class="code" href="namespaceprocessing.html#a1a11e0ad49d1d86515316462ef9be734">subtract_thread_tasks</a>(dir)</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160; </div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <a class="code" href="namespaceprocessing.html#a7cff1a9fec062a47ed93d00489b608de">remove_thread_tasks</a>()</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160; </div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    logging.info(<span class="stringliteral">&quot;[Processing]: [INFO] Tasks to be completed: &quot;</span> + str(threadTasks))</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160; </div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160; </div>
<div class="line"><a name="l00307"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a064a656947735445fff0ca50082629ac">  307</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a064a656947735445fff0ca50082629ac">extraction_process</a>(at_least_one, dir, folder_neo_node, img_list, img_name, index, proc_string):</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        img_path = os.path.join(dir, img_name)</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        logging.info(</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Doing &quot;</span> + str(index + 1) + <span class="stringliteral">&quot; / &quot;</span> + str(</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                len(img_list)))</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160; </div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] I am in &quot;</span> + img_path)</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        i = ImageFeature()</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160; </div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        read_image = cv2.imread(img_path)</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        (h, w) = read_image.shape[:2]</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <span class="keywordflow">if</span> read_image <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;            logging.info(</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [ERR] Read of &quot;</span> + img_path + <span class="stringliteral">&quot; is None&quot;</span>)</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">True</span>, at_least_one</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        image_hash = <a class="code" href="namespaceprocessing.html#a43146e83ae8d3cb5e29c2756c398748f">dhash</a>(read_image)</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160; </div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        existed = ImageNeo.nodes.get_or_none(hash=image_hash)</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        i.hash = image_hash</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160; </div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        <span class="keywordflow">if</span> existed:  <span class="comment"># if an image already exists in DB (found an ImageNeo with the same hashcode)</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160; </div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            logging.info(</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Image &quot;</span> + img_path + <span class="stringliteral">&quot; has already been processed&quot;</span>)</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160; </div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            skip, at_least_one = <a class="code" href="namespaceprocessing.html#a05ebaebd4589a4d0d6e154b9e498d3b5">check_dir_and_connect</a>(at_least_one, dir, existed, folder_neo_node)</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;            <span class="keywordflow">if</span> skip:</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">True</span>, at_least_one</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            tags = []</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160; </div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;            image, norm_feat, propertiesdict = <a class="code" href="namespaceprocessing.html#a0f98b798b9a4c946c5ccf515eecafbb0">creating_image_neo_object_and_extracting_exif_and_image_features</a>(</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                h, w, image_hash, i, img_name, img_path, proc_string)</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160; </div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;            skip, at_least_one = <a class="code" href="namespaceprocessing.html#aeccd7802b767e649e5ddc4d944f688b1">checking_if_image_exists</a>(at_least_one, dir, folder_neo_node, image, image_hash,</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                                                          img_path, proc_string)</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            <span class="keywordflow">if</span> skip:</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">True</span>, at_least_one</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;            skip = <a class="code" href="namespaceprocessing.html#ac39ef3b513c1aead2448730c1b7c8873">extract_locations</a>(image, img_path, proc_string, propertiesdict, tags)</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            <span class="keywordflow">if</span> skip:</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">True</span>, at_least_one</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160; </div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            image.folder.connect(folder_neo_node)</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160; </div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;            <a class="code" href="namespaceprocessing.html#ae0c8c9f888baae6b2016966306dd177f">extract_objects_and_breeds</a>(image, img_path, proc_string, read_image, tags)</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160; </div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;            <a class="code" href="namespaceprocessing.html#a7b09c3fab37ad5df90611f8885411aeb">extract_faces</a>(image, img_path, proc_string, read_image, tags)</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160; </div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;            <a class="code" href="namespaceprocessing.html#ade41c6250b3577a92c8bf8ac81adf955">extract_places</a>(image, img_path, proc_string, tags)</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160; </div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;            <a class="code" href="namespaceprocessing.html#a750883ade380ed378d7f57daeca856d8">extract_text</a>(image, img_path, proc_string, read_image, tags)</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160; </div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;            <a class="code" href="namespaceprocessing.html#aab85657eedf9dfc6ad66e03cae9aecfa">adding_to_es</a>(i, image, img_path, norm_feat, tags)</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160; </div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;            completed = index + 1</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;            logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Finished &quot;</span> + img_path)</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            logging.info(</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Done &quot;</span> + str(completed) + <span class="stringliteral">&quot; / &quot;</span> + str(</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                    len(img_list)))</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            at_least_one |= <span class="keyword">True</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        logging.info(<span class="stringliteral">&quot;[Processing]: [ERR] In &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot;: &quot;</span> + str(e))</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">False</span>, at_least_one</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160; </div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160; </div>
<div class="line"><a name="l00375"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a05ebaebd4589a4d0d6e154b9e498d3b5">  375</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a05ebaebd4589a4d0d6e154b9e498d3b5">check_dir_and_connect</a>(at_least_one, dir, existed, folder_neo_node):</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keywordflow">if</span> existed.folder_uri == dir:</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        at_least_one |= <span class="keyword">True</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">True</span>, at_least_one</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        processingLock.acquire()</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        <span class="comment"># if the current image&#39;s folder is different</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        existed.folder.connect(folder_neo_node)</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        processingLock.release()</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    at_least_one |= <span class="keyword">True</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">True</span>, at_least_one</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160; </div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160; </div>
<div class="line"><a name="l00391"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#aeccd7802b767e649e5ddc4d944f688b1">  391</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#aeccd7802b767e649e5ddc4d944f688b1">checking_if_image_exists</a>(at_least_one, dir, folder_neo_node, image, image_hash, img_path, proc_string):</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        processingLock.acquire()</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        existed = ImageNeo.nodes.get_or_none(hash=image_hash)</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="keywordflow">if</span> existed:</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;            <span class="keywordflow">if</span> existed.folder_uri != dir:</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                <span class="comment"># if the current image&#39;s folder is different</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                existed.folder.connect(folder_neo_node)</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;            at_least_one |= <span class="keyword">True</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;            logging.info(</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Image &quot;</span> + img_path + <span class="stringliteral">&quot; already exists!&quot;</span>)</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">True</span>, at_least_one</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            image.save()</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            at_least_one |= <span class="keyword">True</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;            logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [ERR] Saving image err &quot;</span> + str(e))</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">True</span>, at_least_one</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        processingLock.release()</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">False</span>, at_least_one</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160; </div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160; </div>
<div class="line"><a name="l00416"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ac39ef3b513c1aead2448730c1b7c8873">  416</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#ac39ef3b513c1aead2448730c1b7c8873">extract_locations</a>(image, img_path, proc_string, propertiesdict, tags):</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="keywordflow">if</span> <span class="stringliteral">&quot;latitude&quot;</span> <span class="keywordflow">in</span> propertiesdict <span class="keywordflow">and</span> <span class="stringliteral">&quot;longitude&quot;</span> <span class="keywordflow">in</span> propertiesdict:</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="comment"># crc = [city,region,country] names array</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            locationLock.acquire()</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Location of &quot;</span> + img_path)</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;            crc = <a class="code" href="namespaceprocessing.html#afc9b9d1fd532741dddfb8610a5feb437">get_locations</a>(propertiesdict[<span class="stringliteral">&quot;latitude&quot;</span>], propertiesdict[<span class="stringliteral">&quot;longitude&quot;</span>])</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            crc[0] = crc[0].lower()</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            crc[1] = crc[1].lower()</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;            crc[2] = crc[2].lower()</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;            locationLock.release()</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160; </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;            processingLock.acquire()</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;            db.begin()</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;            location = Location.nodes.get_or_none(name=crc[0])</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;            <span class="keywordflow">if</span> location <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                location = Location(name=crc[0]).save()</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160; </div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;            tags.append(crc[0])</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;            image.location.connect(location,</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                                   {<span class="stringliteral">&#39;latitude&#39;</span>: propertiesdict[<span class="stringliteral">&quot;latitude&quot;</span>], <span class="stringliteral">&#39;longitude&#39;</span>: propertiesdict[<span class="stringliteral">&quot;longitude&quot;</span>]})</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160; </div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            city = City.nodes.get_or_none(name=crc[0])</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            <span class="keywordflow">if</span> city <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                city = City(name=crc[0]).save()</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160; </div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;            tags.append(crc[0])</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;            location.city.connect(city)</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160; </div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;            region = Region.nodes.get_or_none(name=crc[1])</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            <span class="keywordflow">if</span> region <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                region = Region(name=crc[1]).save()</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;            tags.append(crc[1])</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;            city.region.connect(region)</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160; </div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            country = Country.nodes.get_or_none(name=crc[2])</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            <span class="keywordflow">if</span> country <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                country = Country(name=crc[2]).save()</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160; </div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            tags.append(crc[2])</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            region.country.connect(country)</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;            db.commit()</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;            logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [ERR] Extracting locations &quot;</span> + str(e))</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;            db.rollback()</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">True</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;            processingLock.release()</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">False</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160; </div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160; </div>
<div class="line"><a name="l00471"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#aab85657eedf9dfc6ad66e03cae9aecfa">  471</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#aab85657eedf9dfc6ad66e03cae9aecfa">adding_to_es</a>(i, image, img_path, norm_feat, tags):</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="comment"># add features to &quot;cache&quot;</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        resultsLock.acquire()</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        ftManager.np_features.append(norm_feat)</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        i.features = norm_feat</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        ftManager.image_features.append(i)</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        resultsLock.release()</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    ImageES(meta={<span class="stringliteral">&#39;id&#39;</span>: image.hash}, uri=img_path, tags=tags, hash=image.hash).save(using=es)</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160; </div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160; </div>
<div class="line"><a name="l00485"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a750883ade380ed378d7f57daeca856d8">  485</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a750883ade380ed378d7f57daeca856d8">extract_text</a>(image, img_path, proc_string, read_image, tags):</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        ocrLock.acquire()</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] OCR of &quot;</span> + img_path)</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160; </div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        word_list = <a class="code" href="namespaceprocessing.html#a0e2533bd20c0f5728b71449f827b449e">get_ocr</a>(read_image)</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        ocrLock.release()</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="keywordflow">if</span> word_list <span class="keywordflow">and</span> len(word_list) &gt; 0:</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        <span class="keywordflow">for</span> word <span class="keywordflow">in</span> word_list:</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;            <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                processingLock.acquire()</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                t = Tag.nodes.get_or_none(name=word)</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                <span class="keywordflow">if</span> t <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                    t = Tag(name=word).save()</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                tags.append(word)</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                image.tag.connect(t, {<span class="stringliteral">&#39;originalTagName&#39;</span>: word, <span class="stringliteral">&#39;originalTagSource&#39;</span>: <span class="stringliteral">&#39;ocr&#39;</span>, <span class="stringliteral">&#39;score&#39;</span>: 0.6})</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;            <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                processingLock.release()</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160; </div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160; </div>
<div class="line"><a name="l00508"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ade41c6250b3577a92c8bf8ac81adf955">  508</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#ade41c6250b3577a92c8bf8ac81adf955">extract_places</a>(image, img_path, proc_string, tags):</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        placesLock.acquire()</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Places of &quot;</span> + img_path)</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160; </div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        places_list = <a class="code" href="namespaceprocessing.html#aff47640725b84d937ec65b3904081bc8">get_places</a>(img_path)</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        placesLock.release()</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <span class="keywordflow">for</span> places, prob <span class="keywordflow">in</span> places_list:</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160; </div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        places = places.split(<span class="stringliteral">&quot;/&quot;</span>)</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        <span class="keywordflow">for</span> place <span class="keywordflow">in</span> places:</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;            <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                processingLock.acquire()</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                p = <span class="stringliteral">&quot; &quot;</span>.join(place.split(<span class="stringliteral">&quot;_&quot;</span>)).strip()</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                t = Tag.nodes.get_or_none(name=p)</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                <span class="keywordflow">if</span> t <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                    t = Tag(name=p,</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                            originalTagName=p,</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                            originalTagSource=<span class="stringliteral">&#39;places&#39;</span>).save()</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                tags.append(p)</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                image.tag.connect(t, {<span class="stringliteral">&#39;originalTagName&#39;</span>: p, <span class="stringliteral">&#39;originalTagSource&#39;</span>: <span class="stringliteral">&#39;places&#39;</span>, <span class="stringliteral">&#39;score&#39;</span>: prob})</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;            <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                processingLock.release()</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160; </div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160; </div>
<div class="line"><a name="l00536"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a7b09c3fab37ad5df90611f8885411aeb">  536</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a7b09c3fab37ad5df90611f8885411aeb">extract_faces</a>(image, img_path, proc_string, read_image, tags):</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        faceRecLock.acquire()</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Face Recognition of &quot;</span> + img_path)</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160; </div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        db.begin()</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <a class="code" href="namespaceprocessing.html#af9bda498b14617e7bc33bf221cb10d94">face_rec_part</a>(read_image, img_path, tags, image)</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        db.commit()</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        faceRecLock.release()</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160; </div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160; </div>
<div class="line"><a name="l00550"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ae0c8c9f888baae6b2016966306dd177f">  550</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#ae0c8c9f888baae6b2016966306dd177f">extract_objects_and_breeds</a>(image, img_path, proc_string, read_image, tags):</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        objectLock.acquire()</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Objects of &quot;</span> + img_path)</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        res = obj_extr.get_objects(img_path)</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        objectLock.release()</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="keywordflow">for</span> object, confidence <span class="keywordflow">in</span> res:</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            processingLock.acquire()</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;            tag = Tag.nodes.get_or_none(name=object)</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            <span class="keywordflow">if</span> tag <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                tag = Tag(name=object).save()</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;            tags.append(object)</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            image.tag.connect(tag, {<span class="stringliteral">&#39;originalTagName&#39;</span>: object, <span class="stringliteral">&#39;originalTagSource&#39;</span>: <span class="stringliteral">&#39;object&#39;</span>, <span class="stringliteral">&#39;score&#39;</span>: confidence})</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;            processingLock.release()</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160; </div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        <span class="keywordflow">if</span> object <span class="keywordflow">in</span> [<span class="stringliteral">&#39;cat&#39;</span>, <span class="stringliteral">&#39;dog&#39;</span>]:</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;            <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                breedLock.acquire()</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Breeds of &quot;</span> + img_path)</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160; </div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                <a class="code" href="namespaceprocessing.html#a01037731001eee2546cce6a25c65a237">classify_breed_part</a>(read_image, tags, image)</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;            <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                breedLock.release()</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160; </div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160; </div>
<div class="line"><a name="l00580"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a0f98b798b9a4c946c5ccf515eecafbb0">  580</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a0f98b798b9a4c946c5ccf515eecafbb0">creating_image_neo_object_and_extracting_exif_and_image_features</a>(h, w, image_hash, i, img_name, img_path, proc_string):</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="comment"># extract infos</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    norm_feat = model.vgg_extract_feat(img_path)</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    f = json.dumps(norm_feat, cls=NumpyEncoder)</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    i.features = f</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    i_json = json.dumps(i.__dict__)</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Exif of &quot;</span> + img_path)</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    propertiesdict = <a class="code" href="namespaceprocessing.html#a1e995771833c5ba07e9199fb73d75e84">get_exif</a>(img_path)</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    logging.info(proc_string + <span class="stringliteral">&quot; &quot;</span> + threading.current_thread().name + <span class="stringliteral">&quot; [INFO] Thumbnail of &quot;</span> + img_path)</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <a class="code" href="namespaceprocessing.html#a680c8bc1779cc023341f317ea969a323">generate_thumbnail</a>(img_path, image_hash)</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="keywordflow">if</span> <span class="stringliteral">&quot;datetime&quot;</span> <span class="keywordflow">in</span> propertiesdict:</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        image = ImageNeo(folder_uri=os.path.split(img_path)[0],</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                         name=img_name,</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                         processing=i_json,</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                         format=img_name.split(<span class="stringliteral">&quot;.&quot;</span>)[1],</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                         width=w,</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                         height=h,</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                         hash=image_hash,</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                         creation_date=propertiesdict[<span class="stringliteral">&quot;datetime&quot;</span>],</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                         insertion_date=datetime.now())</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        image = ImageNeo(folder_uri=os.path.split(img_path)[0],</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                         name=img_name,</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                         processing=i_json,</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                         format=img_name.split(<span class="stringliteral">&quot;.&quot;</span>)[1],</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                         width=w,</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                         height=h,</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                         hash=image_hash,</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                         insertion_date=datetime.now())</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="keywordflow">return</span> image, norm_feat, propertiesdict</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160; </div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160; </div>
<div class="line"><a name="l00614"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a5170c685dfabb7aa5c9ce4b3d6f6eced">  614</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a5170c685dfabb7aa5c9ce4b3d6f6eced">check_if_folder_exists_and_create_it</a>(dir):</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        processingLock.acquire()</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        db.begin()</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> fs.exist(dir):</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;            last_node = fs.create_uri_in_neo4j(dir)</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            last_node = fs.get_last_node(dir)</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        db.commit()</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        processingLock.release()</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    <span class="keywordflow">return</span> last_node</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160; </div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160; </div>
<div class="line"><a name="l00630"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a7cff1a9fec062a47ed93d00489b608de">  630</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a7cff1a9fec062a47ed93d00489b608de">remove_thread_tasks</a>():</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        uploadLock.acquire()</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="keywordflow">for</span> dir <span class="keywordflow">in</span> threadTasks:</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            <span class="keywordflow">if</span> threadTasks[dir] == 0:</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                threadTasks.pop(dir)</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        uploadLock.release()</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160; </div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160; </div>
<div class="line"><a name="l00642"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a1a11e0ad49d1d86515316462ef9be734">  642</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a1a11e0ad49d1d86515316462ef9be734">subtract_thread_tasks</a>(dir):</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        uploadLock.acquire()</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        threadTasks[dir] -= 1</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        uploadLock.release()</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160; </div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160; </div>
<div class="line"><a name="l00652"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ad699018dcd445ec6dc4f311845473892">  652</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#ad699018dcd445ec6dc4f311845473892">add_thread_tasks</a>(dir_files):</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    <span class="keywordflow">for</span> dir <span class="keywordflow">in</span> dir_files.keys():</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            uploadLock.acquire()</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            threadTasks[dir] += 1</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;            uploadLock.release()</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160; </div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160; </div>
<div class="line"><a name="l00663"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#afc9b9d1fd532741dddfb8610a5feb437">  663</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#afc9b9d1fd532741dddfb8610a5feb437">get_locations</a>(latitude, longitude):</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    results = rg.search((latitude,longitude), mode=1)</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    <span class="keywordflow">return</span> [results[0][<span class="stringliteral">&#39;name&#39;</span>], results[0][<span class="stringliteral">&#39;admin2&#39;</span>], results[0][<span class="stringliteral">&#39;admin1&#39;</span>]]</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160; </div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160; </div>
<div class="line"><a name="l00670"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ad00eb3f59fc6aaa1f0a664759b402d62">  670</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#ad00eb3f59fc6aaa1f0a664759b402d62">already_processed</a>(img_path):</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    image = cv2.imread(img_path)</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    image_hash = <a class="code" href="namespaceprocessing.html#a43146e83ae8d3cb5e29c2756c398748f">dhash</a>(image)</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    existed = ImageNeo.nodes.get_or_none(hash=image_hash)</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160; </div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keywordflow">return</span> existed</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160; </div>
<div class="line"><a name="l00677"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a9aa2833b46f69ba5d6f58508b29f1563">  677</a></span>&#160;to_be_deleted = set()</div>
<div class="line"><a name="l00678"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#aa6c31e9a1f971ce451a9c3b255a84378">  678</a></span>&#160;deleting = <span class="keyword">False</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160; </div>
<div class="line"><a name="l00682"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#afd4f5f8a5b495c94ebee7f5bfbedddae">  682</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#afd4f5f8a5b495c94ebee7f5bfbedddae">delete_folder</a>(uri, frr=frr):</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    logging.info(<span class="stringliteral">&quot;[Deleting]: [INFO] Trying to delete &quot;</span> + uri)</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    deleted_images = <span class="keywordtype">None</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <span class="keyword">global</span> deleting, to_be_deleted</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160; </div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    lock.acquire()</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        <span class="keywordflow">if</span> deleting:</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;            to_be_deleted.add(uri)</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;            logging.info(<span class="stringliteral">&quot;[Deleting]: [INFO] Uri &quot;</span> + uri +  <span class="stringliteral">&quot; added to to_be_deleted, waiting...&quot;</span> )</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;            <span class="keywordflow">return</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        lock.release()</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160; </div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    <span class="keywordflow">if</span> fs.exist(uri):</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;            processingLock.acquire()</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            deleting = <span class="keyword">True</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;            deleted_images = fs.delete_folder_from_fs(uri, frr)</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;            deleting = <span class="keyword">False</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;            processingLock.release()</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        <span class="keywordflow">return</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160; </div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    logging.info(<span class="stringliteral">&quot;[Deleting]: [INFO] Finished deleting folder &quot;</span> + uri)</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    <span class="keywordflow">if</span> deleted_images <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">or</span> len(deleted_images) == 0:</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        <span class="keywordflow">return</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160; </div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    resultsLock.acquire()</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        imgfs = set(ftManager.image_features)</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        <span class="keywordflow">for</span> di <span class="keywordflow">in</span> deleted_images:</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;            imgfs.remove(di)</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        ftManager.image_features = list(imgfs)</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        f = []</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> ftManager.image_features:</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;            f.append(i.features)</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160; </div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        ftManager.np_features = f</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="keywordflow">finally</span>:</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;        resultsLock.release()</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    logging.info(<span class="stringliteral">&quot;[Deleting]: [INFO] Finished deleting images from cache&quot;</span>)</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160; </div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        <span class="keywordflow">if</span> len(to_be_deleted) != 0:</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;            <a class="code" href="namespaceprocessing.html#afd4f5f8a5b495c94ebee7f5bfbedddae">delete_folder</a>(to_be_deleted.pop(), frr)</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        logging.info(<span class="stringliteral">&quot;[Deleting]: [ERROR] &quot;</span> + str(e))</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160; </div>
<div class="line"><a name="l00734"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a0068b0df39e342cb58a3b38e8c41c15e">  734</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a0068b0df39e342cb58a3b38e8c41c15e">find_similar_images</a>(uri):</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    <span class="keywordflow">if</span> len(ftManager.np_features) == 0:</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        <span class="keywordflow">return</span> []</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    norm_feat = model.vgg_extract_feat(uri)</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    feats = np.array(ftManager.np_features)</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    scores = np.dot(norm_feat, feats.T)</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    rank = np.argsort(scores)[::-1]</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160; </div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    maxres = 42  <span class="comment"># 42 imagens com maiores scores</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160; </div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    imlist = []</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    <span class="keywordflow">for</span> i, index <span class="keywordflow">in</span> enumerate(rank[0:maxres]):</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        imlist.append(str(ftManager.image_features[index].hash))</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160; </div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    <span class="keywordflow">return</span> imlist</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160; </div>
<div class="line"><a name="l00752"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a6a85e5384cc452844ac59f4f6f3346d4">  752</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a6a85e5384cc452844ac59f4f6f3346d4">get_all_images_of_folder</a>(folder, page):</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    folder = unquote(folder)</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    folder = fs.get_last_node(folder)</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    node = Folder.nodes.get_or_none(id_=folder.id)</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    <span class="keywordflow">if</span> node:</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        results = node.getImagesByPage(page)</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        <span class="keywordflow">if</span> len(results):</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;            <span class="keywordflow">return</span> [(i, i.tag.all(), i.getPersonsName()) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> results]</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="keywordflow">return</span> []</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160; </div>
<div class="line"><a name="l00764"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#aff47640725b84d937ec65b3904081bc8">  764</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#aff47640725b84d937ec65b3904081bc8">get_places</a>(img_path):</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="comment"># load the test image</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    img = Image.open(img_path).convert(<span class="stringliteral">&#39;RGB&#39;</span>)</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    input_img = V(<a class="code" href="namespaceprocessing.html#ad39cb15a9208e17a561a898f53d96640">centre_crop</a>(img).unsqueeze(0))</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160; </div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    <span class="comment"># forward pass</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    logit = places_model.forward(input_img)</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    h_x = F.softmax(logit, 1).data.squeeze()</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    probs, idx = h_x.sort(0, <span class="keyword">True</span>)</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160; </div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    <span class="keywordflow">return</span> [(classes[idx[i]], probs[i]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(0, 10) <span class="keywordflow">if</span> probs[i] &gt; app.utils.placesThreshold]</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160; </div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160; </div>
<div class="line"><a name="l00779"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a0e2533bd20c0f5728b71449f827b449e">  779</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a0e2533bd20c0f5728b71449f827b449e">get_ocr</a>(image):</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    min_confidence = 0.6</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    results = []</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="comment"># These must be multiple of 32</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    new_w = 128</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    new_h = 128</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    orig = image.copy()</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    (H, W) = image.shape[:2]</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160; </div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="comment"># set the new width and height and then determine the ratio in change</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    <span class="comment"># for both the width and height</span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    r_w = W / float(new_w)</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    r_h = H / float(new_h)</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160; </div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    <span class="comment"># resize the image and grab the new image dimensions</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    image = cv2.resize(image, (new_w, new_h))</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    (H, W) = image.shape[:2]</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160; </div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="comment"># define the two output layer names for the EAST detector model that</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <span class="comment"># we are interested -- the first is the output probabilities and the</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    <span class="comment"># second can be used to derive the bounding box coordinates of text</span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    layer_names = [</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        <span class="stringliteral">&quot;feature_fusion/Conv_7/Sigmoid&quot;</span>,</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        <span class="stringliteral">&quot;feature_fusion/concat_3&quot;</span>]</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160; </div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    <span class="comment"># construct a blob from the image and then perform a forward pass of</span></div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    <span class="comment"># the model to obtain the two output layer sets</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    blob = cv2.dnn.blobFromImage(image, 1.0, (W, H),</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                                 (123.68, 116.78, 103.94), swapRB=<span class="keyword">True</span>, crop=<span class="keyword">False</span>)</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160; </div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    net.setInput(blob)</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    (scores, geometry) = net.forward(layer_names)</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160; </div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    <span class="comment"># grab the number of rows and columns from the scores volume, then</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    <span class="comment"># initialize our set of bounding box rectangles and corresponding</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <span class="comment"># confidence scores</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    (num_rows, num_cols) = scores.shape[2:4]</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    rects = []</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    confidences = []</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <span class="comment"># loop over the number of rows</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    results = <a class="code" href="namespaceprocessing.html#a8f0b7db26a5c12343e8b50b62ad71876">ocr_boxes_algorithm</a>(confidences, geometry, min_confidence, num_cols, num_rows, orig, r_h, r_w, rects, results,</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                                  scores)</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160; </div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <span class="comment"># !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <span class="comment"># Load image, grayscale, Gaussian blur, adaptive threshold</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    gray = cv2.cvtColor(orig, cv2.COLOR_BGR2GRAY)</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    blur = cv2.GaussianBlur(gray, (9, 9), 0)</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    thresh = cv2.adaptiveThreshold(blur, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C, cv2.THRESH_BINARY_INV, 11, 30)</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160; </div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    <span class="comment"># Dilate to combine adjacent text contours</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (9, 9))</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    dilate = cv2.dilate(thresh, kernel, iterations=4)</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160; </div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <span class="comment"># Find contours, highlight text areas, and extract ROIs</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    cnts = cv2.findContours(dilate, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    cnts = cnts[0] <span class="keywordflow">if</span> len(cnts) == 2 <span class="keywordflow">else</span> cnts[1]</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160; </div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keywordflow">for</span> c <span class="keywordflow">in</span> cnts:</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        area = cv2.contourArea(c)</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        <span class="keywordflow">if</span> area &gt; 10000:</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;            x, y, w, h = cv2.boundingRect(c)</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;            ROI = orig[y:y + h, x:x + w]</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;            image_text = pytesseract.image_to_string(ROI, config=custom_config)</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;            result = image_text.replace(<span class="stringliteral">&quot;\x0c&quot;</span>, <span class="stringliteral">&quot; &quot;</span>).replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&quot; &quot;</span>)</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;            results += (re.sub(<span class="stringliteral">&#39;[^0-9a-zA-Z ]+&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, result)).split(<span class="stringliteral">&quot; &quot;</span>)</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160; </div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    <span class="comment"># Transform set into a single string</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="comment"># filter words</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    retrn = []</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    phrase = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    <span class="keywordflow">for</span> ele <span class="keywordflow">in</span> set(results):</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;        phrase += ele</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;        phrase += <span class="stringliteral">&quot; &quot;</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    <span class="keywordflow">for</span> elem <span class="keywordflow">in</span> <a class="code" href="namespaceprocessing.html#aa77cdec045c4ead9c001564b7c299c58">filter_sentence</a>(phrase):</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;        retrn += [elem]</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="keywordflow">return</span> set(retrn)</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160; </div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160; </div>
<div class="line"><a name="l00859"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a8f0b7db26a5c12343e8b50b62ad71876">  859</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a8f0b7db26a5c12343e8b50b62ad71876">ocr_boxes_algorithm</a>(confidences, geometry, min_confidence, num_cols, num_rows, orig, r_h, r_w, rects, results, scores):</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    <span class="keywordflow">for</span> y <span class="keywordflow">in</span> range(0, num_rows):</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;        <span class="comment"># extract the scores (probabilities), followed by the geometrical</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        <span class="comment"># data used to derive potential bounding box coordinates that</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;        <span class="comment"># surround text</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        scores_data = scores[0, 0, y]</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;        x_data0 = geometry[0, 0, y]</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;        x_data1 = geometry[0, 1, y]</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;        x_data2 = geometry[0, 2, y]</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;        x_data3 = geometry[0, 3, y]</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;        angles_data = geometry[0, 4, y]</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;        <span class="comment"># loop over the number of columns</span></div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        <span class="keywordflow">for</span> x <span class="keywordflow">in</span> range(0, num_cols):</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            <span class="comment"># if our score does not have sufficient probability, ignore it</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;            <span class="keywordflow">if</span> scores_data[x] &lt; min_confidence:</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;                <span class="keywordflow">continue</span></div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;            <span class="comment"># compute the offset factor as our resulting feature maps will</span></div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;            <span class="comment"># be 4x smaller than the input image</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;            (offset_x, offset_y) = (x * 4.0, y * 4.0)</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;            <span class="comment"># extract the rotation angle for the prediction and then</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;            <span class="comment"># compute the sin and cosine</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;            angle = angles_data[x]</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;            cos = np.cos(angle)</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;            sin = np.sin(angle)</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;            <span class="comment"># use the geometry volume to derive the width and height of</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;            <span class="comment"># the bounding box</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;            h = x_data0[x] + x_data2[x]</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;            w = x_data1[x] + x_data3[x]</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;            <span class="comment"># compute both the starting and ending (x, y)-coordinates for</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;            <span class="comment"># the text prediction bounding box</span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;            end_x = int(offset_x + (cos * x_data1[x]) + (sin * x_data2[x]))</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;            end_y = int(offset_y - (sin * x_data1[x]) + (cos * x_data2[x]))</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;            start_x = int(end_x - w)</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;            start_y = int(end_y - h)</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;            <span class="comment"># add the bounding box coordinates and probability score to</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;            <span class="comment"># our respective lists</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;            rects.append((start_x, start_y, end_x, end_y))</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;            confidences.append(scores_data[x])</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="comment"># apply non-maxima suppression to suppress weak, overlapping bounding</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="comment"># boxes</span></div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    boxes = non_max_suppression(np.array(rects), probs=confidences)</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    <span class="comment"># loop over the bounding boxes</span></div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    (max_h, max_w) = orig.shape[:2]</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="keywordflow">for</span> (start_x, start_y, end_x, end_y) <span class="keywordflow">in</span> boxes:</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;        <span class="comment"># scale the bounding box coordinates based on the respective</span></div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;        <span class="comment"># ratios</span></div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;        start_x = int(start_x * r_w) - 20</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        <span class="keywordflow">if</span> (start_x &lt;= 0):</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;            start_x = 1</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        start_y = int(start_y * r_h) - 20</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        <span class="keywordflow">if</span> (start_y &lt;= 0):</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;            start_y = 1</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        end_x = int(end_x * r_w) + 20</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        <span class="keywordflow">if</span> (end_x &gt;= max_w):</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;            end_x = max_w - 1</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        end_y = int(end_y * r_h) + 20</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        <span class="keywordflow">if</span> (end_y &gt;= max_h):</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;            end_y = max_h - 1</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        <span class="comment"># draw the bounding box on the image</span></div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        ROI = orig[start_y:end_y, start_x:end_x]</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        image_text = pytesseract.image_to_string(ROI, config=custom_config)</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        result = image_text.replace(<span class="stringliteral">&quot;\x0c&quot;</span>, <span class="stringliteral">&quot; &quot;</span>).replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&quot; &quot;</span>)</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;        results += (re.sub(<span class="stringliteral">&#39;[^0-9a-zA-Z ]+&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, result)).split(<span class="stringliteral">&quot; &quot;</span>)</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="keywordflow">return</span> results</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160; </div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160; </div>
<div class="line"><a name="l00933"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a43146e83ae8d3cb5e29c2756c398748f">  933</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a43146e83ae8d3cb5e29c2756c398748f">dhash</a>(image, hash_size=8):</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="comment"># convert the image to grayscale</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <span class="comment"># resize the grayscale image, adding a single column (width) so we</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="comment"># can compute the horizontal gradient</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    resized = cv2.resize(gray, (hash_size + 1, hash_size))</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <span class="comment"># compute the (relative) horizontal gradient between adjacent</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    <span class="comment"># column pixels</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    diff = resized[:, 1:] &gt; resized[:, :-1]</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    <span class="comment"># convert the difference image to a hash</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    h = sum([2 ** i <span class="keywordflow">for</span> (i, v) <span class="keywordflow">in</span> enumerate(diff.flatten()) <span class="keywordflow">if</span> v])</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="namespaceprocessing.html#aff3f26ba3c3634fa7a0756b6211beac0">convert_hash</a>(h)</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160; </div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160; </div>
<div class="line"><a name="l00949"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#aff3f26ba3c3634fa7a0756b6211beac0">  949</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#aff3f26ba3c3634fa7a0756b6211beac0">convert_hash</a>(h):</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    <span class="comment"># convert the hash to NumPy&#39;s 64-bit float and then back to</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="comment"># Python&#39;s built in int</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    <span class="keywordflow">return</span> int(np.array(h, dtype=<span class="stringliteral">&quot;float64&quot;</span>))</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160; </div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160; </div>
<div class="line"><a name="l00957"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#acb51711f8ca3105c0f43df943346d3e1">  957</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#acb51711f8ca3105c0f43df943346d3e1">load_catgories_places</a>():</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    <span class="comment"># load the class label for scene recognition</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;    file_name = <span class="stringliteral">&#39;categories_places365.txt&#39;</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    <span class="keyword">global</span> classes</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    classes = list()</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="keyword">with</span> open(file_name) <span class="keyword">as</span> class_file:</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> class_file:</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;            classes.append(line.strip().split(<span class="stringliteral">&#39; &#39;</span>)[0][3:])</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    classes = tuple(classes)</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160; </div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160; </div>
<div class="line"><a name="l00970"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a1222a34da92c06a06a51b2016d46a0e8">  970</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a1222a34da92c06a06a51b2016d46a0e8">load_file_system_manager</a>():</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    roots = Folder.nodes.filter(root=<span class="keyword">True</span>)</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160; </div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> roots: <span class="keywordflow">return</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160; </div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    <span class="keyword">def </span>build_uri(node, uri, ids):</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> node: <span class="keywordflow">return</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;        uri += node.name + <span class="stringliteral">&quot;/&quot;</span></div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        ids.append(node.id_)</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160; </div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        <span class="keywordflow">if</span> node.terminated:</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;            fs.add_full_path_uri(uri, ids)</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160; </div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;        <span class="keywordflow">for</span> child <span class="keywordflow">in</span> node.children:</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;            build_uri(child, uri, ids)</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;            ids.pop()  <span class="comment"># backtracking</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160; </div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    <span class="keywordflow">for</span> root <span class="keywordflow">in</span> roots:</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        uri = root.name + <span class="stringliteral">&quot;/&quot;</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        ids = [root.id_]</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        <span class="keywordflow">for</span> child <span class="keywordflow">in</span> root.children:</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;            build_uri(child, uri, ids)</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;            ids.pop()  <span class="comment"># backtracking</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160; </div>
<div class="line"><a name="l00996"></a><span class="lineno"><a class="line" href="classprocessing_1_1_exif_not_found.html">  996</a></span>&#160;<span class="keyword">class </span><a class="code" href="classprocessing_1_1_exif_not_found.html">ExifNotFound</a>(Exception):</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Raised when the exif is not found&quot;&quot;&quot;</span></div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    <span class="keywordflow">pass</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160; </div>
<div class="line"><a name="l01003"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a1e995771833c5ba07e9199fb73d75e84"> 1003</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a1e995771833c5ba07e9199fb73d75e84">get_exif</a>(img_path):</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    returning = {}</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="keywordflow">try</span>:</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <span class="keyword">with</span> open(img_path, <span class="stringliteral">&#39;rb&#39;</span>) <span class="keyword">as</span> image_file:</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;            <span class="comment"># transform into exif image format</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;            current_image = ImgX(image_file)</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;            <span class="comment"># check if it has a exif</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;            <span class="keywordflow">if</span> (current_image.has_exif):</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                <span class="keywordflow">if</span> (<span class="stringliteral">&quot;datetime&quot;</span> <span class="keywordflow">in</span> current_image.list_all()):</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;                    returning[<span class="stringliteral">&quot;datetime&quot;</span>] = current_image.datetime</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160; </div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                <span class="keywordflow">if</span> (<span class="stringliteral">&quot;gps_latitude&quot;</span> <span class="keywordflow">in</span> current_image.list_all()):</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                    latitude = current_image.gps_latitude[0]</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                    latitude += current_image.gps_latitude[1]/60</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                    latitude += current_image.gps_latitude[2]/3600</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                    <span class="keywordflow">if</span> (current_image.gps_latitude_ref == <span class="stringliteral">&quot;S&quot;</span>):</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                        latitude *= -1</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;                    returning[<span class="stringliteral">&quot;latitude&quot;</span>] = latitude</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                <span class="keywordflow">if</span> (<span class="stringliteral">&quot;gps_longitude&quot;</span> <span class="keywordflow">in</span> current_image.list_all()):</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                    longitude = current_image.gps_longitude[0]</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                    longitude += current_image.gps_longitude[1]/60</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                    longitude += current_image.gps_longitude[2]/3600</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                    <span class="keywordflow">if</span> (current_image.gps_longitude_ref == <span class="stringliteral">&quot;W&quot;</span>):</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                        longitude *= -1</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                    returning[<span class="stringliteral">&quot;longitude&quot;</span>] = longitude</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;            <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                <span class="keywordflow">raise</span> ExifNotFound</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160; </div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    <span class="keywordflow">except</span> Exception:</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        <span class="keywordflow">pass</span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160; </div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    image = cv2.imread(img_path)</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;    (H, W) = image.shape[:2]</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    returning[<span class="stringliteral">&quot;height&quot;</span>] = H</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    returning[<span class="stringliteral">&quot;width&quot;</span>] = W</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    <span class="keywordflow">return</span> returning</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160; </div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160; </div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160; </div>
<div class="line"><a name="l01044"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#ab2753b982a0c3c3dec8b512ce4233ef8"> 1044</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#ab2753b982a0c3c3dec8b512ce4233ef8">set_up</a>():</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    images = ImageNeo.nodes.all()</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;    npfeatures = []</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    image_features = []</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160; </div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    <span class="keywordflow">for</span> image <span class="keywordflow">in</span> images:</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;        i = ImageFeature(**json.loads(image.processing))</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;        <span class="keywordflow">if</span> i.features <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;            <span class="keywordflow">continue</span></div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;        i.features = np.array(json.loads(i.features))</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;        npfeatures.append(i.features)</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        image_features.append(i)</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    logging.info(<span class="stringliteral">&quot;[Loading]: [INFO] Loading places&quot;</span>)</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    plc = <a class="code" href="namespacepaths_p_c.html#a185f7998cf8604f1faea677e99324224">do</a>(load_catgories_places)</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    logging.info(<span class="stringliteral">&quot;[Loading]: [INFO] Loading file system&quot;</span>)</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    filess = <a class="code" href="namespacepaths_p_c.html#a185f7998cf8604f1faea677e99324224">do</a>(load_file_system_manager)</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160; </div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    <span class="keywordflow">while</span> <span class="keywordflow">not</span> plc.done():</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        time.sleep(0.1)</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    logging.info(<span class="stringliteral">&quot;[Loading]: [INFO] Finished loading places&quot;</span>)</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    <span class="keywordflow">while</span> <span class="keywordflow">not</span> filess.done():</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        time.sleep(0.1)</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    logging.info(<span class="stringliteral">&quot;[Loading]: [INFO] Finished loading file system&quot;</span>)</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160; </div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    ftManager.np_features = npfeatures</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    ftManager.image_features = image_features</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    <a class="code" href="namespaceprocessing.html#a059ae8f8c3d854183ac4da8ae162027b">testing_thread_capacity</a>()</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160; </div>
<div class="line"><a name="l01074"></a><span class="lineno"><a class="line" href="namespaceprocessing.html#a680c8bc1779cc023341f317ea969a323"> 1074</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprocessing.html#a680c8bc1779cc023341f317ea969a323">generate_thumbnail</a>(imagepath, image_hash):</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    thumbnail_h = 225</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    thumbnail_w = 225</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160; </div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    dim = (thumbnail_w, thumbnail_h)</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160; </div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    <span class="comment"># load the input image</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    image = cv2.imread(imagepath)</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    h,w,p = image.shape</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160; </div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;    padding_lr = 0</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;    padding_tb = 0</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    if(w - thumbnail_w &gt; h - thumbnail_h):</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;        ratio = thumbnail_w/w</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        thumbnail_h = int(h * ratio)</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;        padding_tb = int((thumbnail_w-thumbnail_h)/2)</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;    <span class="keywordflow">else</span>:</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;        ratio = thumbnail_h/h</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        thumbnail_w = int(w * ratio)</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;        padding_lr = int((thumbnail_h-thumbnail_w)/2)</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160; </div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    image = cv2.copyMakeBorder(image, padding_tb, padding_tb, padding_lr, padding_lr, cv2.BORDER_REPLICATE)</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <span class="comment"># resize image</span></div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    resized = cv2.resize(image, dim, interpolation = cv2.INTER_AREA)</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    saving = os.path.join(<span class="stringliteral">&quot;app&quot;</span>, <span class="stringliteral">&quot;static&quot;</span>, <span class="stringliteral">&quot;thumbnails&quot;</span>, str(image_hash)) + <span class="stringliteral">&quot;.jpg&quot;</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    cv2.imwrite(saving, resized, [cv2.IMWRITE_JPEG_QUALITY, 25])</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160; </div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    <span class="comment"># 83 087 673</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;    <span class="comment"># 00 288 957</span></div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;    <span class="comment"># 99,65 %</span></div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;    return(saving)</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160; </div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;<a class="code" href="namespaceprocessing.html#ab2753b982a0c3c3dec8b512ce4233ef8">set_up</a>()</div>
<div class="ttc" id="aclassprocessing_1_1_exif_not_found_html"><div class="ttname"><a href="classprocessing_1_1_exif_not_found.html">processing.ExifNotFound</a></div><div class="ttdoc">Exif not found custom exception in case of exif error.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00996">processing.py:996</a></div></div>
<div class="ttc" id="anamespacepaths_p_c_html_a185f7998cf8604f1faea677e99324224"><div class="ttname"><a href="namespacepaths_p_c.html#a185f7998cf8604f1faea677e99324224">pathsPC.do</a></div><div class="ttdeci">def do(fc, args=None)</div><div class="ttdoc">This function calls and executes a function in a thread.</div><div class="ttdef"><b>Definition:</b> <a href="paths_p_c_8py_source.html#l00016">pathsPC.py:16</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a0068b0df39e342cb58a3b38e8c41c15e"><div class="ttname"><a href="namespaceprocessing.html#a0068b0df39e342cb58a3b38e8c41c15e">processing.find_similar_images</a></div><div class="ttdeci">def find_similar_images(uri)</div><div class="ttdoc">Finding similar images based on a image path.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00734">processing.py:734</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a01037731001eee2546cce6a25c65a237"><div class="ttname"><a href="namespaceprocessing.html#a01037731001eee2546cce6a25c65a237">processing.classify_breed_part</a></div><div class="ttdeci">def classify_breed_part(read_image, tags, image_db)</div><div class="ttdoc">Breeds processing part.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00262">processing.py:262</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a059ae8f8c3d854183ac4da8ae162027b"><div class="ttname"><a href="namespaceprocessing.html#a059ae8f8c3d854183ac4da8ae162027b">processing.testing_thread_capacity</a></div><div class="ttdeci">def testing_thread_capacity()</div><div class="ttdoc">We test the thread capacity on server startup just to see how much a single thread uses of cpu and ra...</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00054">processing.py:54</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a05ebaebd4589a4d0d6e154b9e498d3b5"><div class="ttname"><a href="namespaceprocessing.html#a05ebaebd4589a4d0d6e154b9e498d3b5">processing.check_dir_and_connect</a></div><div class="ttdeci">def check_dir_and_connect(at_least_one, dir, existed, folder_neo_node)</div><div class="ttdoc">Checking if a directory already exists in neo4j and creating or connecting if it exists.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00375">processing.py:375</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a064a656947735445fff0ca50082629ac"><div class="ttname"><a href="namespaceprocessing.html#a064a656947735445fff0ca50082629ac">processing.extraction_process</a></div><div class="ttdeci">def extraction_process(at_least_one, dir, folder_neo_node, img_list, img_name, index, proc_string)</div><div class="ttdoc">Extraction of image features, objects,faces,locations,places,text.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00307">processing.py:307</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a0e2533bd20c0f5728b71449f827b449e"><div class="ttname"><a href="namespaceprocessing.html#a0e2533bd20c0f5728b71449f827b449e">processing.get_ocr</a></div><div class="ttdeci">def get_ocr(image)</div><div class="ttdoc">Get ocr using 2 algorithms.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00779">processing.py:779</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a0f98b798b9a4c946c5ccf515eecafbb0"><div class="ttname"><a href="namespaceprocessing.html#a0f98b798b9a4c946c5ccf515eecafbb0">processing.creating_image_neo_object_and_extracting_exif_and_image_features</a></div><div class="ttdeci">def creating_image_neo_object_and_extracting_exif_and_image_features(h, w, image_hash, i, img_name, img_path, proc_string)</div><div class="ttdoc">Extracting exif data image features and creating neo4j image object.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00580">processing.py:580</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a1222a34da92c06a06a51b2016d46a0e8"><div class="ttname"><a href="namespaceprocessing.html#a1222a34da92c06a06a51b2016d46a0e8">processing.load_file_system_manager</a></div><div class="ttdeci">def load_file_system_manager()</div><div class="ttdoc">Load file system manager.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00970">processing.py:970</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a1a11e0ad49d1d86515316462ef9be734"><div class="ttname"><a href="namespaceprocessing.html#a1a11e0ad49d1d86515316462ef9be734">processing.subtract_thread_tasks</a></div><div class="ttdeci">def subtract_thread_tasks(dir)</div><div class="ttdoc">Subtracting number of threads working on a task.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00642">processing.py:642</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a1e995771833c5ba07e9199fb73d75e84"><div class="ttname"><a href="namespaceprocessing.html#a1e995771833c5ba07e9199fb73d75e84">processing.get_exif</a></div><div class="ttdeci">def get_exif(img_path)</div><div class="ttdoc">get exif metadate from images by checking if exif exists and getting each each parameter</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l01003">processing.py:1003</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a43146e83ae8d3cb5e29c2756c398748f"><div class="ttname"><a href="namespaceprocessing.html#a43146e83ae8d3cb5e29c2756c398748f">processing.dhash</a></div><div class="ttdeci">def dhash(image, hash_size=8)</div><div class="ttdoc">convert the image to grayscale resize the grayscale image, adding a single column (width) so we can c...</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00933">processing.py:933</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a457624c262d19d657f133d859240bd73"><div class="ttname"><a href="namespaceprocessing.html#a457624c262d19d657f133d859240bd73">processing.divide_tasks_to_many</a></div><div class="ttdeci">def divide_tasks_to_many(dir_files, qty)</div><div class="ttdoc">Will divide tasks that threads have into a certain qty that will be how many threads we are going to ...</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00214">processing.py:214</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a5170c685dfabb7aa5c9ce4b3d6f6eced"><div class="ttname"><a href="namespaceprocessing.html#a5170c685dfabb7aa5c9ce4b3d6f6eced">processing.check_if_folder_exists_and_create_it</a></div><div class="ttdeci">def check_if_folder_exists_and_create_it(dir)</div><div class="ttdoc">Checking if a folder already exists in neo4j and get it or create it.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00614">processing.py:614</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a680c8bc1779cc023341f317ea969a323"><div class="ttname"><a href="namespaceprocessing.html#a680c8bc1779cc023341f317ea969a323">processing.generate_thumbnail</a></div><div class="ttdeci">def generate_thumbnail(imagepath, image_hash)</div><div class="ttdoc">Generates a thumbnail of an image.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l01074">processing.py:1074</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a6883b4d7a4f9a026ab1bea1a737b7115"><div class="ttname"><a href="namespaceprocessing.html#a6883b4d7a4f9a026ab1bea1a737b7115">processing.upload_images</a></div><div class="ttdeci">def upload_images(uri)</div><div class="ttdoc">When we upload a directory we call this function that will see how many threads and images there is t...</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00162">processing.py:162</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a6a85e5384cc452844ac59f4f6f3346d4"><div class="ttname"><a href="namespaceprocessing.html#a6a85e5384cc452844ac59f4f6f3346d4">processing.get_all_images_of_folder</a></div><div class="ttdeci">def get_all_images_of_folder(folder, page)</div><div class="ttdoc">Get all images of a folder.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00752">processing.py:752</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a750883ade380ed378d7f57daeca856d8"><div class="ttname"><a href="namespaceprocessing.html#a750883ade380ed378d7f57daeca856d8">processing.extract_text</a></div><div class="ttdeci">def extract_text(image, img_path, proc_string, read_image, tags)</div><div class="ttdoc">Extracting text from an image while processing.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00485">processing.py:485</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a7b09c3fab37ad5df90611f8885411aeb"><div class="ttname"><a href="namespaceprocessing.html#a7b09c3fab37ad5df90611f8885411aeb">processing.extract_faces</a></div><div class="ttdeci">def extract_faces(image, img_path, proc_string, read_image, tags)</div><div class="ttdoc">Extracting faces from an image while processing.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00536">processing.py:536</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a7cff1a9fec062a47ed93d00489b608de"><div class="ttname"><a href="namespaceprocessing.html#a7cff1a9fec062a47ed93d00489b608de">processing.remove_thread_tasks</a></div><div class="ttdeci">def remove_thread_tasks()</div><div class="ttdoc">Removing a task from the threads checker.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00630">processing.py:630</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a86f5bb195977b996d1f35f93c860356f"><div class="ttname"><a href="namespaceprocessing.html#a86f5bb195977b996d1f35f93c860356f">processing.processing</a></div><div class="ttdeci">def processing(dir_files)</div><div class="ttdoc">Processing using every algorithm and modules available of a task with many directories and images.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00274">processing.py:274</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_a8f0b7db26a5c12343e8b50b62ad71876"><div class="ttname"><a href="namespaceprocessing.html#a8f0b7db26a5c12343e8b50b62ad71876">processing.ocr_boxes_algorithm</a></div><div class="ttdeci">def ocr_boxes_algorithm(confidences, geometry, min_confidence, num_cols, num_rows, orig, r_h, r_w, rects, results, scores)</div><div class="ttdoc">OCR boxes algorithm.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00859">processing.py:859</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_aa77cdec045c4ead9c001564b7c299c58"><div class="ttname"><a href="namespaceprocessing.html#aa77cdec045c4ead9c001564b7c299c58">processing.filter_sentence</a></div><div class="ttdeci">def filter_sentence(sentence)</div><div class="ttdoc">This will filter the text that comes out of ocr.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00151">processing.py:151</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_aab85657eedf9dfc6ad66e03cae9aecfa"><div class="ttname"><a href="namespaceprocessing.html#aab85657eedf9dfc6ad66e03cae9aecfa">processing.adding_to_es</a></div><div class="ttdeci">def adding_to_es(i, image, img_path, norm_feat, tags)</div><div class="ttdoc">Adding features to elasticSearch.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00471">processing.py:471</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_ab2753b982a0c3c3dec8b512ce4233ef8"><div class="ttname"><a href="namespaceprocessing.html#ab2753b982a0c3c3dec8b512ce4233ef8">processing.set_up</a></div><div class="ttdeci">def set_up()</div><div class="ttdoc">Load images to memory.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l01044">processing.py:1044</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_ac39ef3b513c1aead2448730c1b7c8873"><div class="ttname"><a href="namespaceprocessing.html#ac39ef3b513c1aead2448730c1b7c8873">processing.extract_locations</a></div><div class="ttdeci">def extract_locations(image, img_path, proc_string, propertiesdict, tags)</div><div class="ttdoc">Extracting locations from latitude and longitude extracted info from exif.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00416">processing.py:416</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_acb51711f8ca3105c0f43df943346d3e1"><div class="ttname"><a href="namespaceprocessing.html#acb51711f8ca3105c0f43df943346d3e1">processing.load_catgories_places</a></div><div class="ttdeci">def load_catgories_places()</div><div class="ttdoc">Load places model.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00957">processing.py:957</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_ad00eb3f59fc6aaa1f0a664759b402d62"><div class="ttname"><a href="namespaceprocessing.html#ad00eb3f59fc6aaa1f0a664759b402d62">processing.already_processed</a></div><div class="ttdeci">def already_processed(img_path)</div><div class="ttdoc">Checking if an image has already been processed.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00670">processing.py:670</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_ad39cb15a9208e17a561a898f53d96640"><div class="ttname"><a href="namespaceprocessing.html#ad39cb15a9208e17a561a898f53d96640">processing.centre_crop</a></div><div class="ttdeci">centre_crop</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00140">processing.py:140</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_ad699018dcd445ec6dc4f311845473892"><div class="ttname"><a href="namespaceprocessing.html#ad699018dcd445ec6dc4f311845473892">processing.add_thread_tasks</a></div><div class="ttdeci">def add_thread_tasks(dir_files)</div><div class="ttdoc">Adding number of threads working on a task.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00652">processing.py:652</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_ade41c6250b3577a92c8bf8ac81adf955"><div class="ttname"><a href="namespaceprocessing.html#ade41c6250b3577a92c8bf8ac81adf955">processing.extract_places</a></div><div class="ttdeci">def extract_places(image, img_path, proc_string, tags)</div><div class="ttdoc">Extracting places from an image while processing.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00508">processing.py:508</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_ae0c8c9f888baae6b2016966306dd177f"><div class="ttname"><a href="namespaceprocessing.html#ae0c8c9f888baae6b2016966306dd177f">processing.extract_objects_and_breeds</a></div><div class="ttdeci">def extract_objects_and_breeds(image, img_path, proc_string, read_image, tags)</div><div class="ttdoc">Extracting objects and breeds from an image while processing.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00550">processing.py:550</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_aeccd7802b767e649e5ddc4d944f688b1"><div class="ttname"><a href="namespaceprocessing.html#aeccd7802b767e649e5ddc4d944f688b1">processing.checking_if_image_exists</a></div><div class="ttdeci">def checking_if_image_exists(at_least_one, dir, folder_neo_node, image, image_hash, img_path, proc_string)</div><div class="ttdoc">Checking if an image already exists in neo4j.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00391">processing.py:391</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_af9bda498b14617e7bc33bf221cb10d94"><div class="ttname"><a href="namespaceprocessing.html#af9bda498b14617e7bc33bf221cb10d94">processing.face_rec_part</a></div><div class="ttdeci">def face_rec_part(read_image, img_path, tags, image)</div><div class="ttdoc">Face recognition processing part.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00236">processing.py:236</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_afc9b9d1fd532741dddfb8610a5feb437"><div class="ttname"><a href="namespaceprocessing.html#afc9b9d1fd532741dddfb8610a5feb437">processing.get_locations</a></div><div class="ttdeci">def get_locations(latitude, longitude)</div><div class="ttdoc">Get latitude and longitude locations through reverse_geocoding.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00663">processing.py:663</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_afd4f5f8a5b495c94ebee7f5bfbedddae"><div class="ttname"><a href="namespaceprocessing.html#afd4f5f8a5b495c94ebee7f5bfbedddae">processing.delete_folder</a></div><div class="ttdeci">def delete_folder(uri, frr=frr)</div><div class="ttdoc">Deleting a folder and their respective images.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00682">processing.py:682</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_aff3f26ba3c3634fa7a0756b6211beac0"><div class="ttname"><a href="namespaceprocessing.html#aff3f26ba3c3634fa7a0756b6211beac0">processing.convert_hash</a></div><div class="ttdeci">def convert_hash(h)</div><div class="ttdoc">Converts the hash to NumPy's 64-bit float and then back to Python's built in int More details.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00949">processing.py:949</a></div></div>
<div class="ttc" id="anamespaceprocessing_html_aff47640725b84d937ec65b3904081bc8"><div class="ttname"><a href="namespaceprocessing.html#aff47640725b84d937ec65b3904081bc8">processing.get_places</a></div><div class="ttdeci">def get_places(img_path)</div><div class="ttdoc">Get places from the places trained model.</div><div class="ttdef"><b>Definition:</b> <a href="processing_8py_source.html#l00764">processing.py:764</a></div></div>
<div class="ttc" id="anamespaceutils_html_a49f82a60715bd4d6d1fcf976ecf2319a"><div class="ttname"><a href="namespaceutils.html#a49f82a60715bd4d6d1fcf976ecf2319a">utils.get_images_per_uri</a></div><div class="ttdeci">def get_images_per_uri(path_name)</div><div class="ttdoc">Gets all images of a path.</div><div class="ttdef"><b>Definition:</b> <a href="utils_8py_source.html#l00088">utils.py:88</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_d422163b96683743ed3963d4aac17747.html">app</a></li><li class="navelem"><a class="el" href="processing_8py.html">processing.py</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
